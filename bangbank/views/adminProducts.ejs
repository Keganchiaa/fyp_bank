<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Products</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>

  <nav style="background: #f0f0f0; padding: 10px; display: flex; justify-content: space-between; align-items: center;">
    <div>
      <a href="/admin/dashboard">Dashboard</a> |
      <a href="/admin/products">Manage Products</a> |
      <a href="/admin/accounts">Account Applications</a> |
      <a href="/admin/creditcards">Credit Card Applications</a>
    </div>
    <div>
      <strong>Welcome, <%= user.username %> (<%= user.role %>)</strong>
    </div>
    <form action="/logout" method="GET" style="margin: 0;">
      <button type="submit">Logout</button>
    </form>
  </nav>

  <% if (typeof success !== 'undefined' && success) { %>
    <div style="color: green;"><%= success %></div>
  <% } %>
  <% if (typeof error !== 'undefined' && error) { %>
    <div style="color: red;"><%= error %></div>
  <% } %>

  <h2>Create New Product</h2>
  <form action="/admin/products/create" method="POST">
    <label>Product Name:</label>
    <input type="text" name="product_name" required>

    <label>Product Type:</label>
    <select name="product_type" id="product_type" required onchange="toggleFields()">
      <option value="">Select Type</option>
      <option value="savings">Savings</option>
      <option value="fixed_deposit">Fixed Deposit</option>
      <option value="credit_card">Credit Card</option>
    </select>

    <label>Description:</label>
    <textarea name="description" required></textarea>

    <label>Interest Rate (%):</label>
    <input type="number" name="interest_rate" step="0.01" required>

    <div id="annual_fee_group">
      <label>Annual Fee ($):</label>
      <input type="number" name="annual_fee" step="0.01">
    </div>

    <div id="min_balance_group">
      <label>Minimum Balance ($):</label>
      <input type="number" name="min_balance" step="0.01">
    </div>

    <div id="tenure_group">
      <label>Tenure (Months):</label>
      <input type="number" name="tenure_months">
    </div>

    <button type="submit">Create Product</button>
  </form>

  <hr>

<% const grouped = { savings: [], fixed_deposit: [], credit_card: [] }; %>
<% products.forEach(p => { grouped[p.product_type].push(p); }); %>

<% Object.entries(grouped).forEach(([type, list]) => { %>
  <h2><%= type.replace('_', ' ').toUpperCase() %> Products</h2>

  <% if (list.length === 0) { %>
    <p>No <%= type.replace('_', ' ') %> products found.</p>
  <% } else { %>
    <table border="1" cellpadding="6">
      <tr>
        <th>Name</th>
        <th>Description</th>
        <th>Interest Rate</th>
        <% if (type === 'credit_card') { %>
          <th>Annual Fee</th>
        <% } %>
        <% if (type === 'savings' || type === 'fixed_deposit') { %>
          <th>Min Balance</th>
        <% } %>
        <% if (type === 'fixed_deposit') { %>
          <th>Tenure (Months)</th>
        <% } %>
        <th>Actions</th>
      </tr>

      <% list.forEach(p => { %>
        <tr>
          <td><%= p.product_name %></td>
          <td><%= p.description || '-' %></td>
          <td><%= p.interest_rate != null ? p.interest_rate + '%' : '-' %></td>

          <% if (p.product_type === 'credit_card') { %>
            <td><%= p.annual_fee != null ? '$' + parseFloat(p.annual_fee).toFixed(2) : '-' %></td>
          <% } %>

          <% if (p.product_type === 'savings' || p.product_type === 'fixed_deposit') { %>
            <td><%= p.min_balance != null ? '$' + parseFloat(p.min_balance).toFixed(2) : '-' %></td>
          <% } %>

          <% if (p.product_type === 'fixed_deposit') { %>
            <td><%= p.tenure_months != null ? p.tenure_months : '-' %></td>
          <% } %>

          <td>
            <a href="/admin/products/edit/<%= p.product_id %>">Edit</a>
            <form action="/admin/products/delete/<%= p.product_id %>" method="POST" style="display:inline;">
              <button type="submit" onclick="return confirm('Delete this product?')">Delete</button>
            </form>
          </td>
        </tr>
      <% }) %>
    </table>
  <% } %>
  <hr>
<% }) %>

  <!-- âœ… Dynamic field toggle script -->
  <script>
    function toggleFields() {
      const type = document.getElementById('product_type').value;

      const annualFee = document.getElementById('annual_fee_group');
      const minBalance = document.getElementById('min_balance_group');
      const tenure = document.getElementById('tenure_group');

      annualFee.style.display = 'none';
      minBalance.style.display = 'none';
      tenure.style.display = 'none';

      if (type === 'savings') {
        minBalance.style.display = 'block';
      } else if (type === 'fixed_deposit') {
        minBalance.style.display = 'block';
        tenure.style.display = 'block';
      } else if (type === 'credit_card') {
        annualFee.style.display = 'block';
      }
    }

    window.onload = toggleFields;
  </script>

</body>
</html>
